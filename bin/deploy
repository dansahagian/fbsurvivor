#!/bin/zsh

run_command() {
    local check="$1"
    shift
    if ! "$@"; then
        echo -e "\n\n‚ùå Failed Deployment $check\n"
        exit 1
    fi
}

echo -e "\nLinting and Formatting üêç ...\n"

run_command "linting" .venv/bin/ruff check .
run_command "imports" .venv/bin/ruff check --select I
run_command "format" .venv/bin/ruff format --check

echo -e "\nRunning Tests üß™...\n"

run_command "tests" .venv/bin/pytest -p no:warnings .

echo "\nDeploying...\n"

rsync -a ./fbsurvivor dan@linode:/opt/fbsurvivor
rsync -a ./requirements dan@linode:/opt/fbsurvivor
rsync -a ./manage.py dan@linode:/opt/fbsurvivor
rsync -a ./bin dan@linode:/opt/fbsurvivor
rsync -a ./prod.env dan@linode:/opt/fbsurvivor/prod.env

ssh linode /opt/fbsurvivor/bin/deploy_on_server $OP_SERVICE_ACCOUNT_TOKEN

sleep 2

curl -X GET -I https://fbsurvivor.com
