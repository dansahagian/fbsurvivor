#!/bin/zsh

echo "\nInstalling Dependencies...\n"
cd /opt/fbsurvivor
.venv/bin/uv pip install --upgrade pip
.venv/bin/uv pip sync requirements/prod.txt

echo "\nStopping services...\n"
sudo systemctl stop wsgi-server-fbsurvivor.service

export OP_SERVICE_ACCOUNT_TOKEN="$1"
export ENV=prod

op run --env-file="./prod.env" -- .venv/bin/python manage.py migrate
op run --env-file="./prod.env" -- .venv/bin/python manage.py collectstatic --no-input
op run --env-file="./prod.env" -- .venv/bin/python manage.py check --deploy

echo "\nStarting services...\n"
sudo systemctl start wsgi-server-fbsurvivor.service
